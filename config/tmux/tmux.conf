# =============================================================================
# プレフィックスキーの設定
# =============================================================================
# プレフィックスキーを Ctrl+y に変更（デフォルトは Ctrl+b）
# tmux のほとんどの操作は「プレフィックス + キー」で行う
set -g prefix C-y

# プレフィックスを2回押すと、本来の Ctrl+y をアプリケーションに送信
# 例: Vim で Ctrl+y（スクロールアップ）を使いたい場合は Ctrl+y → Ctrl+y
bind -T prefix C-y send-keys C-y

# =============================================================================
# 基本オプション
# =============================================================================
# ターミナルの色設定（256色 + True Color対応）
# "tmux-256color" は tmux 専用のターミナルタイプ
set -g  default-terminal "tmux-256color"

# True Color (24bit カラー) を有効化
# terminal-features: tmux 3.2以降の新しい方法
# terminal-overrides: 古いターミナルとの互換性のため
set -as terminal-features ",*:RGB"
set -ag terminal-overrides ",*256col*:Tc"

# Escキーの遅延をなくす（Vim使用時に重要）
# 0に設定すると、Escを押した瞬間に反応する
set -sg escape-time 0

# スクロールバックの履歴を10000行に設定
# デフォルトは2000行
set  -g history-limit 10000

# ステータスバーの更新間隔（秒）
# 1秒ごとに更新すると負荷がかかるので10秒に
set  -g status-interval 10

# ウィンドウとペインの番号を1から始める（デフォルトは0）
# キーボードの配置的に1から始める方が押しやすい
set  -g base-index 1
set  -g pane-base-index 1

# ステータスバーを画面上部に表示
set  -g status-position top

# コピーモードで vi キーバインドを使用
# hjkl で移動、v で選択、y でコピーなど
setw -g mode-keys vi

# マウス操作を有効化
# ペインのクリック選択、リサイズ、スクロールなどが可能
set  -g mouse on

# フォーカスイベントを有効化
# Neovim の autoread などが正しく動作するために必要
set  -g focus-events on

# =============================================================================
# プロセス検出（スマートキーバインド用）
# =============================================================================
# 現在のペインで動作中のプロセスを検出するための変数
# これにより、Vim内では Vim のキー、それ以外では tmux のキーとして動作

# Zsh が実行中かどうか（シェルプロンプト表示中）
# "Ss+" は「セッションリーダーでフォアグラウンド」を意味
is_zsh="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE 'Ss\\+\\s*-zsh'"

# Vim/Neovim が実行中かどうか
# view, vim, nvim, vimdiff などにマッチ
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE 'S\\+\\s*?g?(view|n?vim?x?)(diff)?'"

# fzf が実行中かどうか
is_fzf="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE 'S\\+\\s*fzf'"

# Claude Code が実行中かどうか
# Node.js で動作するため、claude または node.*claude にマッチ
is_claude="ps -o comm= -t '#{pane_tty}' | grep -qE '(claude|node.*claude)'"

# =============================================================================
# 設定ファイルのリロード
# =============================================================================
# プレフィックス + R で設定ファイルを再読み込み
# \; で複数コマンドを連結、display-message で完了通知
bind R source-file ~/.config/tmux/tmux.conf \; display-message "Tmux config reloaded!"

# =============================================================================
# ペイン移動（Neovim連携対応）
# =============================================================================
# 基本のペイン移動（プレフィックス + hjkl）
# Vim風のキーバインドで上下左右のペインに移動
bind -T prefix h select-pane -L  # 左のペインへ
bind -T prefix j select-pane -D  # 下のペインへ
bind -T prefix k select-pane -U  # 上のペインへ
bind -T prefix l select-pane -R  # 右のペインへ

# スマートペイン移動（プレフィックス不要、Ctrl+hjkl）
# Vim/Claude/fzf が動作中はそのアプリにキーを送信
# それ以外の場合は tmux のペイン移動として動作

# Ctrl+h: 左に移動
# if-shell でプロセスを検出し、条件分岐
bind -n C-h if-shell "$is_vim" 'send-keys C-h' {
  if-shell "$is_claude" 'select-pane -L' {
    if-shell "$is_zsh || $is_fzf" 'send-keys C-h' {
      if -F '#{pane_at_left}' '' 'select-pane -L'
    }
  }
}

# Ctrl+j: 下に移動
bind -n C-j if-shell "$is_vim" 'send-keys C-j' {
  if-shell "$is_claude" 'select-pane -D' {
    if-shell "$is_zsh || $is_fzf" 'send-keys C-j' {
      if -F '#{pane_at_bottom}' '' 'select-pane -D'
    }
  }
}

# Ctrl+k: 上に移動
bind -n C-k if-shell "$is_vim" 'send-keys C-k' {
  if-shell "$is_claude" 'select-pane -U' {
    if-shell "$is_zsh || $is_fzf" 'send-keys C-k' {
      if -F '#{pane_at_top}' '' 'select-pane -U'
    }
  }
}

# Ctrl+l: 右に移動
bind -n C-l if-shell "$is_vim" 'send-keys C-l' {
  if-shell "$is_claude" 'select-pane -R' {
    if-shell "$is_fzf" 'send-keys C-l' 'select-pane -R'
  }
}

# コピーモード中のペイン移動
# #{pane_at_*} で端かどうかを判定し、端でなければ移動
bind -T copy-mode-vi C-h if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi C-j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi C-k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi C-l if -F '#{pane_at_right}'  '' 'select-pane -R'

# プレフィックス + Ctrl+l で画面クリア（Ctrl+l）を送信
# 通常の Ctrl+l は上記でペイン移動に使っているため
bind -T prefix C-l send-keys C-l

# =============================================================================
# ウィンドウ操作
# =============================================================================
# プレフィックス + c: 新規ウィンドウ作成
bind -T prefix c   new-window

# Alt+c: 新規ウィンドウ作成（カレントパスを引き継ぐ）
# Vim内では Alt+c をそのまま送信
bind -n M-c        if-shell "$is_vim" 'send-keys M-c' 'new-window -c "#{pane_current_path}"'

# プレフィックス + n/p: 次/前のウィンドウへ
bind -T prefix n   next-window
bind -T prefix p   previous-window

# Alt+j/k: 次/前のウィンドウへ（Vim風）
bind -n M-j        next-window
bind -n M-k        previous-window

# Alt+z: ペインの最大化/復元（ズームトグル）
bind -n M-z        resize-pane -Z

# =============================================================================
# 画面分割（ウィンドウを複数のペインに分割）
# =============================================================================
# プレフィックス + v: 縦に分割（左右に並ぶ）
# -h は horizontal（水平線で分割 = 左右に並ぶ）
# -c でカレントパスを引き継ぐ
bind -T prefix v split-window -h  -c "#{pane_current_path}"

# プレフィックス + s: 横に分割（上下に並ぶ）
# -v は vertical（垂直線で分割 = 上下に並ぶ）
bind -T prefix s split-window -v  -c "#{pane_current_path}"

# Alt+v: 縦に分割（プレフィックス不要）
# Vim内では Alt+v をそのまま送信（ビジュアルブロック選択など）
bind -n M-v      if-shell "$is_vim" 'send-keys M-v' 'split-window -h  -c "#{pane_current_path}"'

# Alt+s: 横に分割（プレフィックス不要）
bind -n M-s      split-window -v  -c "#{pane_current_path}"

# プレフィックス + V/S: フルサイズで分割
# -f オプションで、既存のペインを含めた全体を分割
bind -T prefix V split-window -fh -c "#{pane_current_path}"
bind -T prefix S split-window -fv -c "#{pane_current_path}"

# プレフィックス + 3: 66%幅で縦分割（メイン:サブ = 2:1）
# プレフィックス + 4: 75%幅で縦分割（メイン:サブ = 3:1）
bind -T prefix 3 split-window -h  -c "#{pane_current_path}" -l 66%
bind -T prefix 4 split-window -h  -c "#{pane_current_path}" -l 75%

# =============================================================================
# ペインのリサイズ
# =============================================================================
# プレフィックス + H/J/K/L: ペインサイズを5単位で変更
# -r オプションでリピート可能（一定時間内は連続入力可）
bind -r -T prefix H resize-pane -L 5  # 左に5単位拡大
bind -r -T prefix L resize-pane -R 5  # 右に5単位拡大
bind -r -T prefix J resize-pane -D 5  # 下に5単位拡大
bind -r -T prefix K resize-pane -U 5  # 上に5単位拡大

# =============================================================================
# ウィンドウ・セッション間の移動（矢印キー）
# =============================================================================
# Alt+←/→: 前/次のウィンドウへ移動
# Alt+↑/↓: 前/次のセッションへ移動
bind -n M-Left  previous-window   # 前のウィンドウ
bind -n M-Right next-window       # 次のウィンドウ
bind -n M-Up    switch-client -p  # 前のセッション
bind -n M-Down  switch-client -n  # 次のセッション

# =============================================================================
# ペインの入れ替え（スワップ）
# =============================================================================
# プレフィックス + m または Alt+m: ペインをマーク
# マークしたペインは、別のペインで再度実行すると入れ替わる
bind-key -T prefix m select-pane -m
bind-key -n M-m      select-pane -m

# =============================================================================
# 履歴のクリア
# =============================================================================
# プレフィックス + Ctrl+c: ペインのスクロールバック履歴をクリア
bind -T prefix C-c clear-history

# =============================================================================
# セッション操作
# =============================================================================
# Alt+Shift+C: 新規セッション作成（ホームディレクトリで開始）
bind -n M-C new-session -c '~/'

# Alt+l/h: 次/前のセッションへ切り替え（Vim風）
bind -n M-l switch-client -n  # 次のセッション
bind -n M-h switch-client -p  # 前のセッション

# Alt+d: デタッチ（セッションを残してtmuxから抜ける）
# 後で tmux attach で再接続可能
bind -n M-d detach

# セッション切り替え時にステータスバーをリフレッシュ
set-hook -g client-session-changed 'run-shell "tmux refresh-client -S"'

# =============================================================================
# ツリー・セッション選択
# =============================================================================
# プレフィックス + a: ツリー表示（全セッション・ウィンドウ・ペイン）
# プレフィックス + e: セッション一覧のみ表示
# プレフィックス + w: ウィンドウツリー表示
bind -T prefix a   choose-tree
bind -T prefix e   choose-session
bind -T prefix w   choose-tree -w

# Ctrl押しながらでも同じ動作（押し間違い対策）
bind -T prefix C-a choose-tree
bind -T prefix C-e choose-session
bind -T prefix C-w choose-tree -w

# =============================================================================
# コピーモード
# =============================================================================
# Alt+[ でコピーモードに入る（vi風の操作で選択・コピー）
bind -n M-'[' copy-mode

# コピーモード中の操作
# Ctrl+a/e: 行頭/行末へ移動（Emacs風）
bind -T copy-mode-vi C-a send-keys -X start-of-line
bind -T copy-mode-vi C-e send-keys -X end-of-line

# v: 選択開始（通常選択）
# V: 行選択
# Ctrl+v: 矩形選択（ブロック選択）
bind -T copy-mode-vi v   send-keys -X begin-selection
bind -T copy-mode-vi V   send-keys -X select-line
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# y/Y/Enter: 選択範囲をコピーしてコピーモード終了
# pbcopy は macOS のクリップボードコマンド
bind -T copy-mode-vi y   send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Y   send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# Escape: コピーモードをキャンセル
bind -T copy-mode-vi Escape send-keys -X cancel

# クリップボードからペースト
# Alt+]: 改行を削除してペースト（コマンド実行時に便利）
# Alt+}: 改行を保持してペースト
bind -n M-']' run "pbpaste | tr -d '\n' | tmux load-buffer - && tmux paste-buffer"
bind -n M-'}' run "pbpaste | tmux load-buffer - && tmux paste-buffer"

# プレフィックス版も用意
bind -T prefix ] run "pbpaste | tr -d '\n' | tmux load-buffer - && tmux paste-buffer"
bind -T prefix '}' run "pbpaste | tmux load-buffer - && tmux paste-buffer"

# =============================================================================
# ステータスライン（基本設定）
# =============================================================================
# ペインの境界線にステータスを表示（bottom: 下部に表示）
set-option -g pane-border-status bottom

# =============================================================================
# ローカル設定の読み込み
# =============================================================================
# ~/.config/tmux/tmux.conf.local が存在すれば読み込む
# マシン固有の設定やプライベートな設定を分離できる
if "test -e ~/.config/tmux/tmux.conf.local" "source ~/.config/tmux/tmux.conf.local"
