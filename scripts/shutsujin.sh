#!/bin/bash
# ============================================================
# wezterm-shogun å‡ºé™£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (bash ç‰ˆ)
# ============================================================
# ä½¿ç”¨æ–¹æ³•:
#   ./scripts/shutsujin.sh           # å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•
#   ./scripts/shutsujin.sh -s        # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ï¼ˆClaudeèµ·å‹•ãªã—ï¼‰
#   ./scripts/shutsujin.sh -h        # ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
# ============================================================

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_DIR"

# å…±é€šé–¢æ•°èª­ã¿è¾¼ã¿
source "$SCRIPT_DIR/../lib/common.sh"
source "$SCRIPT_DIR/../lib/pane_manager.sh"

# ============================================================
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
# ============================================================
SETUP_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--setup-only)
            SETUP_ONLY=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            exit 1
            ;;
    esac
done

# ============================================================
# ãƒãƒŠãƒ¼è¡¨ç¤º
# ============================================================
show_battle_cry

# ============================================================
# STEP 1: æ—¢å­˜ãƒšã‚¤ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ============================================================
log_info "ğŸ§¹ æ—¢å­˜ã®é™£ã‚’æ’¤åä¸­..."
cleanup_existing_panes

# ============================================================
# STEP 2: ã‚­ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
# ============================================================
log_info "ğŸ“œ å‰å›ã®è»è­°è¨˜éŒ²ã‚’ç ´æ£„ä¸­..."
reset_queue_files

# ============================================================
# STEP 3: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
# ============================================================
log_info "ğŸ“Š æˆ¦æ³å ±å‘Šæ¿ã‚’åˆæœŸåŒ–ä¸­..."
init_dashboard

# ============================================================
# STEP 4: å°†è»ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ
# ============================================================
log_war "ğŸ‘‘ å°†è»ã®æœ¬é™£ã‚’æ§‹ç¯‰ä¸­..."
SHOGUN_PANE=$(wezterm cli spawn --workspace shogun --cwd "$PROJECT_DIR")
log_success "  â””â”€ å°†è» Pane ID: $SHOGUN_PANE"

# ============================================================
# STEP 5: å®¶è€ãƒ»è¶³è»½ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ (3x3 ã‚°ãƒªãƒƒãƒ‰)
# ============================================================
log_war "âš”ï¸ å®¶è€ãƒ»è¶³è»½ã®é™£ã‚’æ§‹ç¯‰ä¸­..."
create_multiagent_grid

# ãƒšã‚¤ãƒ³IDã‚’ä¿å­˜
save_pane_ids

log_success "âœ… ãƒšã‚¤ãƒ³æ§‹ç¯‰å®Œäº†"

# ============================================================
# STEP 6: Claude Code èµ·å‹•
# ============================================================
if [ "$SETUP_ONLY" = false ]; then
    log_war "ğŸ‘‘ å…¨è»ã« Claude Code ã‚’å¬å–šä¸­..."
    launch_claude_code_all

    log_success "âœ… å…¨è» Claude Code èµ·å‹•å®Œäº†"

    # ============================================================
    # STEP 7: æŒ‡ç¤ºæ›¸èª­ã¿è¾¼ã¿
    # ============================================================
    log_info "ğŸ“œ å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æŒ‡ç¤ºæ›¸ã‚’ä¼é”ä¸­..."
    sleep 15  # Claude Code èµ·å‹•å¾…æ©Ÿ

    send_instructions_to_all

    log_success "âœ… å…¨è»ã«æŒ‡ç¤ºæ›¸ä¼é”å®Œäº†"
fi

# ============================================================
# STEP 8: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# ============================================================
show_completion_message "$SETUP_ONLY"
